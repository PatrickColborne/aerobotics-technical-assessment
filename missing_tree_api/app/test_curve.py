import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.spatial import cKDTree

# --- YOUR DATA ---
grid_data = [
    [-32.3279643, 18.826872], [-32.3281893, 18.8263421], [-32.3283205, 18.8256169], [-32.3287595, 18.8262246],
    [-32.3280753, 18.8255473], [-32.3280162, 18.8263217], [-32.3279874, 18.8261944], [-32.3282152, 18.8259209],
    [-32.3280811, 18.8263693], [-32.3281056, 18.8256815], [-32.3284156, 18.8260619], [-32.3287805, 18.8260976],
    [-32.3280739, 18.8268465], [-32.3285469, 18.8266393], [-32.3283032, 18.8255558], [-32.3283363, 18.8265001],
    [-32.328172, 18.825729], [-32.3287098, 18.8263234], [-32.3286179, 18.8264124], [-32.3286795, 18.8256509],
    [-32.3281215, 18.8257392], [-32.3286392, 18.8260042], [-32.3282368, 18.8257817], [-32.3286492, 18.8255184],
    [-32.3279066, 18.8258055], [-32.3285671, 18.8253996], [-32.3281489, 18.82587], [-32.3285526, 18.8261638],
    [-32.3280595, 18.8267803], [-32.327911, 18.8260772], [-32.3286305, 18.8259345], [-32.3278331, 18.8262385],
    [-32.3281936, 18.8266071], [-32.3276788, 18.8260738], [-32.3287069, 18.82605], [-32.328929, 18.8254335],
    [-32.3283075, 18.8266478], [-32.3278216, 18.8267056], [-32.3285941, 18.8262823], [-32.3288713, 18.8259974],
    [-32.3284171, 18.8263404], [-32.3277264, 18.8268007], [-32.3275332, 18.8259073], [-32.3288683, 18.8264768],
    [-32.3283219, 18.8264355], [-32.3285281, 18.8265765], [-32.3276846, 18.826354], [-32.3275202, 18.8258479],
    [-32.3285189, 18.8262373], [-32.3288194, 18.8257375], [-32.3276615, 18.8262164], [-32.3285022, 18.8264525],
    [-32.328916, 18.8253724], [-32.3279787, 18.8263982], [-32.328942, 18.8255015], [-32.3287502, 18.8259685],
    [-32.3288021, 18.8259464], [-32.3279859, 18.8259192], [-32.328433, 18.8266767], [-32.3279513, 18.8265408],
    [-32.3284531, 18.8259154], [-32.3278937, 18.8257392], [-32.3283637, 18.8263574], [-32.3280422, 18.8261791],
    [-32.3277797, 18.8267871], [-32.3287459, 18.826517], [-32.3282037, 18.8264067], [-32.3277249, 18.8265408],
    [-32.3277076, 18.8259328], [-32.3286536, 18.826067], [-32.3283234, 18.8261655], [-32.3288987, 18.8252977],
    [-32.3278836, 18.8259464], [-32.3279643, 18.826337], [-32.3283378, 18.82623], [-32.3285411, 18.8255507],
    [-32.3286326, 18.8262045], [-32.3280278, 18.8263795], [-32.328544, 18.8258292], [-32.3282686, 18.8264576],
    [-32.3282657, 18.8259023], [-32.3279629, 18.8266003], [-32.3286132, 18.8258683], [-32.3282224, 18.8257171],
    [-32.3287697, 18.8262944], [-32.3282916, 18.8257579], [-32.3280537, 18.8256934], [-32.3280955, 18.8267005],
    [-32.3276543, 18.8256713], [-32.3284445, 18.8256475], [-32.3285973, 18.8260857], [-32.3282282, 18.8262606],
    [-32.3283926, 18.8259362], [-32.3279095, 18.8266138], [-32.3287199, 18.8261128], [-32.3286637, 18.8255796],
    [-32.3281474, 18.8264185], [-32.3283464, 18.8257443], [-32.3278691, 18.8264338], [-32.3289449, 18.8257817],
    [-32.3284589, 18.8265272], [-32.3283753, 18.8258751], [-32.3278547, 18.826371], [-32.3284577, 18.8257102],
    [-32.3284041, 18.8262759], [-32.3280018, 18.8265272], [-32.32781, 18.8269263], [-32.3290126, 18.8255507],
    [-32.3283666, 18.826624], [-32.3280638, 18.8260313], [-32.3278302, 18.8259702], [-32.3277682, 18.8270028],
    [-32.3283897, 18.826765], [-32.3279614, 18.8260619], [-32.3276312, 18.8260908], [-32.3277653, 18.826191],
    [-32.3279239, 18.8264151], [-32.3287487, 18.8254267], [-32.3280826, 18.8260993], [-32.3286377, 18.8257273],
    [-32.3280537, 18.8262436], [-32.3278446, 18.8257562], [-32.3285945, 18.8258105], [-32.3278288, 18.82569],
    [-32.328766, 18.826033], [-32.3288309, 18.8260789], [-32.3286925, 18.8257086], [-32.3288439, 18.8253231],
    [-32.328195, 18.8255847], [-32.3274899, 18.8257154], [-32.3279009, 18.8268227], [-32.3286844, 18.8259086],
    [-32.3288569, 18.8253843], [-32.32884, 18.8263413], [-32.327973, 18.8261247], [-32.3288684, 18.8257239],
    [-32.3287343, 18.8261791], [-32.3276701, 18.8260092], [-32.3280883, 18.8256203], [-32.3290689, 18.8252552],
    [-32.3282614, 18.8256407], [-32.3281763, 18.8262759], [-32.3279167, 18.8268907], [-32.328903, 18.8261281],
    [-32.3280393, 18.8264491], [-32.3284474, 18.8264678], [-32.3289593, 18.8255643], [-32.3281071, 18.8264933],
    [-32.3280984, 18.8261638], [-32.3277783, 18.8265255], [-32.3286111, 18.8263494], [-32.3277408, 18.8265952],
    [-32.328867, 18.8254454], [-32.3282296, 18.8265323], [-32.3281316, 18.8258038], [-32.3275606, 18.8260398],
    [-32.3279196, 18.8255949], [-32.3285973, 18.8255354], [-32.328594, 18.8265544], [-32.3281186, 18.8260194],
    [-32.3280191, 18.8255626], [-32.3276932, 18.8266648], [-32.3285646, 18.8264311], [-32.3276139, 18.8262997],
    [-32.3279066, 18.8263506], [-32.3287055, 18.8255032], [-32.3284803, 18.8257719], [-32.3279853, 18.8269578],
    [-32.3284474, 18.8262012], [-32.3280105, 18.8257766], [-32.3289867, 18.8256968], [-32.3286911, 18.8259804],
    [-32.3289953, 18.8254811], [-32.3284575, 18.8254369], [-32.3283363, 18.8267633], [-32.3283623, 18.8260789],
    [-32.3283219, 18.8258921], [-32.3275908, 18.8258921], [-32.327947, 18.825729], [-32.3285584, 18.8267107],
    [-32.3278158, 18.8259006], [-32.3281878, 18.825797], [-32.3283536, 18.8262946], [-32.3288454, 18.8255966],
    [-32.3281186, 18.8268244], [-32.3281244, 18.8265595], [-32.3286326, 18.8264754], [-32.3283868, 18.8256594],
    [-32.3285759, 18.8262193], [-32.3288165, 18.8254641], [-32.3283508, 18.8254726], [-32.3281835, 18.8255201],
    [-32.3282556, 18.8261162], [-32.3281099, 18.826765], [-32.3275058, 18.8257783], [-32.3288857, 18.8260636],
    [-32.3277379, 18.8260568], [-32.3281359, 18.8263557], [-32.3276846, 18.8258004], [-32.3286406, 18.8254522],
    [-32.3283609, 18.8255371], [-32.3277855, 18.8257647], [-32.3277076, 18.826208], [-32.3280004, 18.825712],
    [-32.3276557, 18.825943], [-32.3276024, 18.82623], [-32.3280667, 18.8263082], [-32.3275764, 18.8258275],
    [-32.3279167, 18.8258734], [-32.3281503, 18.8266835], [-32.3288353, 18.8266291], [-32.3290227, 18.8253367],
    [-32.3282123, 18.8256526], [-32.3288581, 18.8264043], [-32.3284185, 18.8266121], [-32.3283363, 18.8259566],
    [-32.3279758, 18.8266665], [-32.3287944, 18.8258791], [-32.3283753, 18.8261451], [-32.3285844, 18.8260228],
    [-32.3279326, 18.8256611], [-32.3283349, 18.8256747], [-32.3284748, 18.8255048], [-32.3288064, 18.8256815],
    [-32.3286507, 18.8262743], [-32.3280321, 18.8266529], [-32.3277221, 18.8262691], [-32.3284248, 18.825784],
    [-32.3279903, 18.8264661], [-32.327624, 18.8263591], [-32.3278648, 18.8256051], [-32.3286218, 18.825386],
    [-32.328394, 18.8264831], [-32.3287617, 18.8265816], [-32.3285267, 18.8254862], [-32.3278533, 18.8260925],
    [-32.3279917, 18.8267276], [-32.3282441, 18.8265918], [-32.3282945, 18.8265816], [-32.3280018, 18.8262606],
    [-32.3287761, 18.8258241], [-32.3277408, 18.8268652], [-32.3276947, 18.8258632], [-32.328296, 18.8263082],
    [-32.3277725, 18.825977], [-32.3281056, 18.8259583], [-32.3281619, 18.8259311], [-32.3278389, 18.8267701],
    [-32.3284474, 18.8267429], [-32.3278288, 18.8265136], [-32.3279499, 18.8268041], [-32.3281619, 18.8264814],
    [-32.328133, 18.8260823], [-32.3276961, 18.8261383], [-32.3282152, 18.8261978], [-32.3278504, 18.8268397],
    [-32.327921, 18.8266801], [-32.3284863, 18.8255677], [-32.3285793, 18.8264968], [-32.3286709, 18.8258482],
    [-32.3282556, 18.8266631], [-32.3277898, 18.8265833], [-32.3277509, 18.8266546], [-32.3278533, 18.8258207],
    [-32.3287992, 18.8254097], [-32.3289506, 18.8252824], [-32.32827, 18.8261825], [-32.327823, 18.8269858],
    [-32.3279297, 18.8269603], [-32.3283075, 18.8263727], [-32.3288872, 18.8257919], [-32.3289535, 18.8258377],
    [-32.3280826, 18.8266359], [-32.3277913, 18.8260432], [-32.3289823, 18.8254097], [-32.3285079, 18.8254199],
    [-32.3281561, 18.8256713], [-32.3279874, 18.8256458], [-32.3287334, 18.8266551], [-32.3287343, 18.8256305],
    [-32.3286093, 18.8266187], [-32.3282513, 18.8255728], [-32.3284622, 18.8259784], [-32.3281734, 18.8265442],
    [-32.3278403, 18.8263031], [-32.3283522, 18.8260211], [-32.3290415, 18.8254013], [-32.328557, 18.8258904],
    [-32.3278028, 18.8263795], [-32.3278562, 18.8266274], [-32.3285064, 18.8261689], [-32.3277985, 18.8261111],
    [-32.3286507, 18.8257885], [-32.3277639, 18.8267191], [-32.3288598, 18.8256628], [-32.3282383, 18.8255048],
    [-32.328766, 18.8257596], [-32.3280725, 18.8258224], [-32.3278417, 18.8260262], [-32.3282239, 18.8259855],
    [-32.327748, 18.8261264], [-32.3279369, 18.8264797], [-32.3276673, 18.8265595], [-32.3288207, 18.8264969],
    [-32.3282484, 18.8258377], [-32.3280523, 18.8259702], [-32.3284315, 18.8264016], [-32.3276038, 18.8259566],
    [-32.3284301, 18.8261315], [-32.3284056, 18.8254573], [-32.3281994, 18.8266767], [-32.3287733, 18.8255456],
    [-32.3282138, 18.8267395], [-32.3283926, 18.8262096], [-32.3284012, 18.8265476], [-32.3288569, 18.826208],
    [-32.3279744, 18.8258547], [-32.3283782, 18.8264219], [-32.3283104, 18.826101], [-32.327549, 18.8256968],
    [-32.3280004, 18.8259821], [-32.3285022, 18.8256322], [-32.3278965, 18.8260109], [-32.3278042, 18.8266444],
    [-32.3285252, 18.825763], [-32.3286651, 18.8261298], [-32.3281287, 18.8255286], [-32.3287862, 18.8253333],
    [-32.3277639, 18.8256339], [-32.3275706, 18.8261027], [-32.3277004, 18.8264134], [-32.3282123, 18.8264661],
    [-32.3282815, 18.8262419], [-32.3287906, 18.8261604], [-32.3278836, 18.8264899], [-32.3287141, 18.8255643],
    [-32.3276153, 18.8257494], [-32.3278821, 18.8256747], [-32.3280378, 18.8256322], [-32.3278446, 18.826568],
    [-32.3286462, 18.8265425], [-32.3288476, 18.8258603], [-32.327797, 18.826855], [-32.3278864, 18.8267599],
    [-32.3276038, 18.8256866], [-32.3277221, 18.8257222], [-32.3282844, 18.8267854], [-32.3285411, 18.8260976],
    [-32.3279989, 18.8267922], [-32.3287603, 18.8254828], [-32.328296, 18.8260364], [-32.3286939, 18.8254318],
    [-32.3280436, 18.826714], [-32.3282556, 18.8263914], [-32.3279355, 18.8259413], [-32.3284719, 18.8263251],
    [-32.3276153, 18.8260279], [-32.3283089, 18.8258292], [-32.3276384, 18.826427], [-32.3275461, 18.8259736],
    [-32.327898, 18.8265527], [-32.3280681, 18.8265748], [-32.3277653, 18.8264542], [-32.3288309, 18.8265626],
    [-32.3281345, 18.8266189], [-32.3281575, 18.8267463], [-32.3283796, 18.8266937], [-32.3277379, 18.8257902],
    [-32.3278677, 18.825887], [-32.3285022, 18.8267276], [-32.3284056, 18.8260025], [-32.3288439, 18.8261451],
    [-32.3284358, 18.825583], [-32.3284293, 18.825847], [-32.3284618, 18.8262606], [-32.3279715, 18.8255796],
    [-32.3287329, 18.8253554], [-32.3284185, 18.8255218], [-32.3280148, 18.8265884], [-32.3285166, 18.826517],
    [-32.3286564, 18.8266109], [-32.3275908, 18.8261672], [-32.328283, 18.8259719], [-32.3289275, 18.8259838],
    [-32.3276283, 18.8258156], [-32.3276413, 18.8258785], [-32.3282311, 18.8268007], [-32.3289189, 18.8256407],
    [-32.3287844, 18.8263614], [-32.3288194, 18.826016], [-32.3287473, 18.8256934], [-32.3290516, 18.8254658],
    [-32.32827, 18.8267225], [-32.3287264, 18.8258288], [-32.327947, 18.8260008], [-32.3284112, 18.8257209],
    [-32.3281835, 18.8260653], [-32.3288324, 18.825532], [-32.3280378, 18.825904], [-32.3285815, 18.8254709],
    [-32.3286229, 18.8266884], [-32.3281633, 18.8262096], [-32.3280249, 18.8258377], [-32.3286132, 18.8255983],
    [-32.328681, 18.8261927], [-32.3281085, 18.8262249], [-32.3280306, 18.8261128], [-32.3277884, 18.8263166],
    [-32.3282801, 18.8256968], [-32.3282844, 18.8265103], [-32.3280912, 18.8258921], [-32.3277581, 18.8269365],
    [-32.3280552, 18.8265136], [-32.3282412, 18.8260585], [-32.3285137, 18.8257036], [-32.3287377, 18.8258925],
    [-32.328557, 18.8256118], [-32.328916, 18.8261961], [-32.3285325, 18.8260227], [-32.3289708, 18.825352],
    [-32.3280652, 18.8257562], [-32.3285711, 18.8256739], [-32.3284758, 18.8260428], [-32.3284863, 18.826388],
    [-32.3287436, 18.8264419], [-32.3278042, 18.8258394], [-32.3290804, 18.8253248], [-32.3288324, 18.8258071],
    [-32.3286598, 18.8263279], [-32.3275606, 18.8257647], [-32.3285844, 18.8257409], [-32.3288915, 18.826337],
    [-32.3280926, 18.8264338], [-32.3276701, 18.8262827], [-32.3289131, 18.8259141], [-32.3288298, 18.826285],
    [-32.3287055, 18.8257749], [-32.327761, 18.8259141], [-32.328551, 18.8263654], [-32.3281979, 18.8258615],
    [-32.328537, 18.8262949], [-32.3288139, 18.8262139], [-32.3284939, 18.8258322], [-32.3279398, 18.8267429],
    [-32.3288583, 18.8259362], [-32.3284921, 18.826658], [-32.3289016, 18.8255813], [-32.3283609, 18.8258105],
    [-32.328929, 18.8257103], [-32.3276456, 18.826157], [-32.3277148, 18.8264797], [-32.3290054, 18.8252654],
    [-32.328503, 18.825898], [-32.3280148, 18.82605], [-32.3278634, 18.826906], [-32.3286968, 18.8262572],
    [-32.3278951, 18.8262895], [-32.328146, 18.8261502], [-32.3282051, 18.8261315], [-32.3276514, 18.8264916],
    [-32.3277523, 18.8263999], [-32.3281186, 18.8262946], [-32.3284704, 18.8265969], [-32.3276802, 18.8266054],
    [-32.3288713, 18.8262708], [-32.3279196, 18.826117], [-32.3280191, 18.8268533], [-32.3283508, 18.8265595],
    [-32.3277033, 18.8256509], [-32.3289434, 18.8260483], [-32.3281792, 18.8268142], [-32.3281748, 18.8260008],
    [-32.3286779, 18.826399], [-32.3289723, 18.8256254], [-32.3287017, 18.826521], [-32.3279484, 18.8262759],
    [-32.3283782, 18.8256017], [-32.3286103, 18.8261451], [-32.3286915, 18.826458], [-32.3278201, 18.8261757],
    [-32.328721, 18.8265948], [-32.3277206, 18.8259906], [-32.3277466, 18.8258496], [-32.32796, 18.8257885],
    [-32.3281402, 18.8256], [-32.3278749, 18.826692], [-32.3278115, 18.8256169], [-32.3279369, 18.8262063],
    [-32.328319, 18.8267056], [-32.3277091, 18.8267327], [-32.3276716, 18.8257409], [-32.3286766, 18.8253707],
    [-32.3282397, 18.8263234], [-32.3277769, 18.8262538]
]


class FlowGuidedIndexer:
    def __init__(self, data):
        self.raw_data = np.array(data)
        self.ref_lat = np.median(self.raw_data[:, 0])
        self.ref_lon = np.median(self.raw_data[:, 1])
        self.R = 6371000
        self.meters = self._to_meters(self.raw_data)

    def _to_meters(self, coords):
        lats = np.radians(coords[:, 0])
        lons = np.radians(coords[:, 1])
        ref_lat_rad = np.radians(self.ref_lat)
        ref_lon_rad = np.radians(self.ref_lon)
        x = (lons - ref_lon_rad) * np.cos(ref_lat_rad) * self.R
        y = (lats - ref_lat_rad) * self.R
        return np.column_stack((x, y))

    def _to_latlon(self, meters):
        if len(meters) == 0: return np.array([])
        x = meters[:, 0]
        y = meters[:, 1]
        ref_lat_rad = np.radians(self.ref_lat)
        lat_rad = (y / self.R) + ref_lat_rad
        lon_rad = (x / (self.R * np.cos(ref_lat_rad))) + np.radians(self.ref_lon)
        return np.column_stack((np.degrees(lat_rad), np.degrees(lon_rad)))

    def calculate_flow_field(self, k_neighbors=5):
        """
        Calculates a 'Flow Vector' for every single tree based on the
        orientation of its local neighborhood (PCA).
        """
        tree = cKDTree(self.meters)
        dists, indices = tree.query(self.meters, k=k_neighbors)

        flow_vectors = np.zeros_like(self.meters)

        for i in range(len(self.meters)):
            neighbors = self.meters[indices[i]]
            # Center the neighbors
            centered = neighbors - np.mean(neighbors, axis=0)
            # PCA
            cov = np.cov(centered.T)
            evals, evecs = np.linalg.eig(cov)
            # Principal component (direction of greatest variance = row direction)
            major_axis = evecs[:, np.argmax(evals)]
            flow_vectors[i] = major_axis

        return flow_vectors

    def cluster_chains_with_flow(self):
        # 1. Calculate Flow Map
        flow_field = self.calculate_flow_field()

        # 2. Build Neighbor Graph
        tree = cKDTree(self.meters)
        dists, indices = tree.query(self.meters, k=15)  # Look far for gaps
        median_spacing = np.median(dists[:, 1])

        visited = set()
        rows = []

        # Sort processing order (Top-Left to Bottom-Right roughly)
        # Use PCA on the whole block to find the perpendicular axis for sorting
        global_mean = np.mean(self.meters, axis=0)
        global_centered = self.meters - global_mean
        g_cov = np.cov(global_centered.T)
        g_evals, g_evecs = np.linalg.eig(g_cov)
        # Minor axis (perpendicular to rows)
        perp_vec = g_evecs[:, np.argmin(g_evals)]
        projections = np.dot(self.meters, perp_vec)
        sort_order = np.argsort(projections)

        for idx in sort_order:
            if idx in visited: continue

            chain = [idx]
            visited.add(idx)

            # Walk "Forward" relative to flow
            curr = idx
            while True:
                local_indices = indices[curr]
                best_next = -1
                best_dist = float('inf')

                # Retrieve pre-calculated flow for this specific tree
                flow_vec = flow_field[curr]

                # Ensure flow vector points in the same direction as previous step
                # (PCA vectors define a line, not a ray, so they might flip 180)
                if len(chain) > 1:
                    prev_vec = self.meters[curr] - self.meters[chain[-2]]
                    if np.dot(flow_vec, prev_vec) < 0:
                        flow_vec = -flow_vec

                for n_idx in local_indices:
                    if n_idx == curr or n_idx in visited: continue

                    vec = self.meters[n_idx] - self.meters[curr]
                    dist = np.linalg.norm(vec)

                    # Gap Jumping Logic
                    # We allow jumps up to 3.5x spacing
                    if dist > median_spacing * 3.5: continue

                    # Alignment Check
                    if dist > 0:
                        unit_vec = vec / dist
                        alignment = np.dot(flow_vec, unit_vec)

                        # The further the jump, the stricter the alignment must be
                        ratio = dist / median_spacing
                        is_valid = False

                        if ratio < 1.5 and alignment > 0.8:  # Normal neighbor
                            is_valid = True
                        elif 1.5 <= ratio < 2.5 and alignment > 0.95:  # Gap of 1
                            is_valid = True
                        elif 2.5 <= ratio < 3.5 and alignment > 0.98:  # Gap of 2
                            is_valid = True

                        if is_valid:
                            if dist < best_dist:
                                best_dist = dist
                                best_next = n_idx

                if best_next != -1:
                    chain.append(best_next)
                    visited.add(best_next)
                    curr = best_next
                else:
                    break

            if len(chain) > 3:
                rows.append(chain)

        return rows

    def fit_and_plot(self):
        rows = self.cluster_chains_with_flow()

        plt.figure(figsize=(10, 10))
        plt.scatter(self.meters[:, 0], self.meters[:, 1], c='gray', s=10, alpha=0.5, label='Tree')

        equations = []

        for r_idx, indices in enumerate(rows):
            points = self.meters[indices]

            # Local PCA Rotation
            mean = np.mean(points, axis=0)
            centered = points - mean
            cov = np.cov(centered.T)
            evals, evecs = np.linalg.eig(cov)
            angle = np.arctan2(evecs[1, 0], evecs[0, 0])

            c, s = np.cos(-angle), np.sin(-angle)
            R = np.array([[c, -s], [s, c]])
            rotated = np.dot(centered, R.T)

            # Fit Parabola
            xs = rotated[:, 0]
            ys = rotated[:, 1]
            coeffs = np.polyfit(xs, ys, 2)

            # Dynamic Range + Buffer
            min_x, max_x = np.min(xs), np.max(xs)
            buffer = 5.0

            # Generate Curve
            t = np.linspace(min_x - buffer, max_x + buffer, 50)
            y_curve = np.polyval(coeffs, t)
            curve_local = np.column_stack((t, y_curve))

            # Rotate Back
            c_inv, s_inv = np.cos(angle), np.sin(angle)
            R_inv = np.array([[c_inv, -s_inv], [s_inv, c_inv]])
            curve_global = np.dot(curve_local, R_inv.T) + mean

            # Plot
            gps_pts = self._to_latlon(curve_global)
            plt.plot(gps_pts[:, 1], gps_pts[:, 0], 'r-', linewidth=1.5, alpha=0.6)

            # Store Equation Data
            equations.append({
                'row_id': r_idx,
                'a': coeffs[0], 'b': coeffs[1], 'c': coeffs[2],
                'angle': angle, 'cx': mean[0], 'cy': mean[1]
            })

        plt.title("Flow-Guided Row Clustering (Robust to Gaps)")
        plt.axis('equal')
        plt.show()
        return pd.DataFrame(equations)


# --- RUN ---
indexer = FlowGuidedIndexer(grid_data)
df_eqs = indexer.fit_and_plot()
print(df_eqs.head())